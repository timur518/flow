<?php

namespace App\Filament\Pages;

use App\Models\Category;
use App\Models\OrderSetting;
use App\Services\TelegramService;
use Filament\Actions\Action;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Toggle;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Forms\Contracts\HasForms;
use Filament\Notifications\Notification;
use Filament\Pages\Page;
use Filament\Schemas\Components\Section;
use Filament\Schemas\Components\Tabs;
use Filament\Schemas\Components\Tabs\Tab;
use Filament\Schemas\Schema;

class OrderSettings extends Page implements HasForms
{
    use InteractsWithForms;

    protected static string|\BackedEnum|null $navigationIcon = 'heroicon-o-shopping-cart';
    protected static ?string $navigationLabel = 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²';
    protected static ?string $title = 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²';
    protected static string|\UnitEnum|null $navigationGroup = 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸';
    protected static ?int $navigationSort = 2;

    protected string $view = 'filament.pages.order-settings';

    public ?array $data = [];

    public function mount(): void
    {
        $settings = OrderSetting::first();

        if (!$settings) {
            $settings = OrderSetting::create([]);
        }

        $this->form->fill($settings->toArray());
    }

    public function form(Schema $schema): Schema
    {
        return $schema
            ->schema([
                Tabs::make('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²')
                    ->tabs([
                        Tab::make('Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ğ°Ğ¼Ğ¸')
                            ->icon('heroicon-o-currency-dollar')
                            ->schema([
                                Section::make('ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²')
                                    ->description('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒÑÑ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²')
                                    ->schema([
                                        Toggle::make('bulk_price_change_enabled')
                                            ->label('ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½')
                                            ->helperText('Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ')
                                            ->live(),

                                        TextInput::make('price_change_percentage')
                                            ->label('ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½Ñ‹')
                                            ->suffix('%')
                                            ->numeric()
                                            ->helperText('ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ Ñ†ĞµĞ½Ñ‹, Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ - ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚. ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 10 Ğ¸Ğ»Ğ¸ -15')
                                            ->placeholder('ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 10 Ğ¸Ğ»Ğ¸ -15')
                                            ->visible(fn ($get) => $get('bulk_price_change_enabled')),

                                        Select::make('selected_category_ids')
                                            ->label('ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğº ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼')
                                            ->options(Category::where('is_active', true)->pluck('name', 'id'))
                                            ->multiple()
                                            ->searchable()
                                            ->placeholder('Ğ’ÑĞµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹')
                                            ->helperText('ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞºĞ¾ Ğ²ÑĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼')
                                            ->visible(fn ($get) => $get('bulk_price_change_enabled')),
                                    ]),
                            ]),

                        Tab::make('Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ')
                            ->icon('heroicon-o-chat-bubble-left-right')
                            ->schema([
                                Section::make('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Telegram Ğ±Ğ¾Ñ‚Ğ°')
                                    ->schema([
                                        Toggle::make('telegram_notifications_enabled')
                                            ->label('Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ')
                                            ->helperText('Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ… Ğ² Telegram'),

                                        TextInput::make('telegram_bot_token')
                                            ->label('Telegram Bot Token')
                                            ->placeholder('1234567890:ABCdefGHIjklMNOpqrsTUVwxyz')
                                            ->password()
                                            ->revealable()
                                            ->helperText('ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ñƒ @BotFather Ğ² Telegram'),

                                        TextInput::make('telegram_chat_ids')
                                            ->label('Telegram Chat ID')
                                            ->placeholder('123456789, 987654321')
                                            ->helperText('ID Ñ‡Ğ°Ñ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ ID Ñƒ @userinfobot')
                                            ->belowContent(
                                                Action::make('test_telegram')
                                                    ->label('ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ')
                                                    ->color('success')
                                                    ->action(fn () => $this->sendTestTelegramMessage())
                                            ),
                                    ]),
                            ]),

                        Tab::make('Email ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ')
                            ->icon('heroicon-o-envelope')
                            ->schema([
                                Section::make('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ email Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²')
                                    ->schema([
                                        Toggle::make('email_new_order_to_customer')
                                            ->label('ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ')
                                            ->helperText('ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ°')
                                            ->default(true),

                                        Toggle::make('email_delivery_complete_to_customer')
                                            ->label('ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ')
                                            ->helperText('ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°')
                                            ->default(true),
                                    ]),

                                Section::make('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ email Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°')
                                    ->schema([
                                        Toggle::make('email_new_order_to_admin')
                                            ->label('ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ')
                                            ->helperText('ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğµ')
                                            ->default(true),

                                        TextInput::make('admin_email')
                                            ->label('Email Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ğ¸Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²')
                                            ->email()
                                            ->placeholder('admin@example.com')
                                            ->helperText('ĞĞ° ÑÑ‚Ğ¾Ñ‚ email Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ…'),
                                    ]),
                            ]),
                    ])
                    ->persistTabInQueryString()
                    ->columnSpanFull(),
            ])
            ->statePath('data');
    }

    public function sendTestTelegramMessage(): void
    {
        $token = $this->data['telegram_bot_token'] ?? null;
        $chatIds = $this->data['telegram_chat_ids'] ?? null;

        if (!$token || !$chatIds) {
            Notification::make()
                ->warning()
                ->title('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ')
                ->body('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Bot Token Ğ¸ Chat ID Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ')
                ->send();
            return;
        }

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹
        $this->save();

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        $telegramService = app(TelegramService::class);
        $chatIdsArray = array_map('trim', explode(',', $chatIds));

        $successCount = 0;
        foreach ($chatIdsArray as $chatId) {
            if ($telegramService->sendMessage($chatId, "ğŸ§ª <b>Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ</b>\n\nĞ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ²Ğ¸Ğ´Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Telegram Ğ±Ğ¾Ñ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾! âœ…")) {
                $successCount++;
            }
        }

        if ($successCount > 0) {
            Notification::make()
                ->success()
                ->title('Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾')
                ->body("Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² {$successCount} Ñ‡Ğ°Ñ‚(Ğ¾Ğ²)")
                ->send();
        } else {
            Notification::make()
                ->danger()
                ->title('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸')
                ->body('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° Ğ¸ Chat ID')
                ->send();
        }
    }

    public function save(): void
    {
        $data = $this->form->getState();

        $settings = OrderSetting::first();

        if (!$settings) {
            $settings = OrderSetting::create($data);
        } else {
            $settings->update($data);
        }

        Notification::make()
            ->success()
            ->title('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹')
            ->body('ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹.')
            ->send();
    }
}
